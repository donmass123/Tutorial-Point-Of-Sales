
# Steps for Implementing Due Collections in Cash Register

## Step 1.2: Add DB Import to CashRegisterUtil

Make sure you have the DB facade imported at the top of your `app/Utils/CashRegisterUtil.php`:

```php
use Illuminate\Support\Facades\DB;
```

---

## Step 2: Update the Controller

Now update your `app/Http/Controllers/CashRegisterController.php` to call the utility method.

### 2.1 Update `getRegisterDetails` Method

Update your existing `getRegisterDetails()` method in the controller to include the due collections logic:

```php
public function getRegisterDetails()
{
    if (!auth()->user()->can('view_cash_register')) {
        abort(403, 'Unauthorized action.');
    }

    $business_id = request()->session()->get('user.business_id');
    $register_details = $this->cashRegisterUtil->getRegisterDetails();
    $user_id = auth()->user()->id;
    $open_time = $register_details['open_time'];
    $close_time = \Carbon::now()->toDateTimeString();

    $is_types_of_service_enabled = $this->moduleUtil->isModuleEnabled('types_of_service');
    $details = $this->cashRegisterUtil->getRegisterTransactionDetails($user_id, $open_time, $close_time, $is_types_of_service_enabled);

    // Add due collections data using utility method
    $due_collections = $this->cashRegisterUtil->getTodayDueCollections($user_id, $open_time, $close_time);
    $details['due_collections'] = $due_collections;

    $payment_types = $this->cashRegisterUtil->payment_types($register_details->location_id, true, $business_id);

    return view('cash_register.register_details')
        ->with(compact('register_details', 'details', 'payment_types', 'close_time'));
}
```

### 2.2 Update `closeRegister` Method (Optional)

If you want the same feature in your close register modal, update your `closeRegister()` method similarly:

```php
public function closeRegister()
{
    // ... existing code ...

    $details = $this->cashRegisterUtil->getRegisterTransactionDetails($user_id, $open_time, $close_time, $is_types_of_service_enabled);

    // Add due collections data for close register modal too
    $due_collections = $this->cashRegisterUtil->getTodayDueCollections($user_id, $open_time, $close_time);
    $details['due_collections'] = $due_collections;

    // ... rest of existing code ...
}
```

---

## Step 3: Update the Register Details View

Update your `resources/views/cash_register/register_details.blade.php` file.

### 3.1 Add Due Collections Section

In the `modal-body` section, add the following code to display the due collections information:

```html
<div class="modal-dialog modal-lg" role="document">
  <div class="modal-content">
    <div class="modal-header mini_print">
      <button type="button" class="close no-print" data-dismiss="modal" aria-label="Close"><span
          aria-hidden="true">&times;</span></button>
      <h3 class="modal-title">@lang( 'cash_register.register_details' ) ( {{ \Carbon::createFromFormat('Y-m-d H:i:s',
        $register_details->open_time)->format('jS M, Y h:i A') }} - {{\Carbon::createFromFormat('Y-m-d H:i:s',
        $close_time)->format('jS M, Y h:i A')}} )</h3>
    </div>

    <div class="modal-body">
      @include('cash_register.payment_details')

      <!-- Add Due Collections Section -->
      @if(isset($details['due_collections']))
      <hr class="no-print">
      <div class="row no-print">
        <div class="col-md-12">
          <h4><i class="fa fa-clock-o"></i> @lang('lang_v1.due_collections_today')</h4>
          <div class="row">
            <div class="col-md-4">
              <div class="info-box bg-green due-collection-box">
                <span class="info-box-icon due-collection-icon">
                  <i class="fa fa-check-circle"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text due-collection-title">@lang('lang_v1.collected_today')</span>
                  <span class="info-box-number due-collection-amount">
                    @format_currency($details['due_collections']['due_collected_today'])
                  </span>
                  <span class="progress-description due-collection-desc">
                    {{ $details['due_collections']['due_transactions_count'] }} @lang('lang_v1.transactions')
                  </span>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-box bg-yellow due-collection-box">
                <span class="info-box-icon due-collection-icon">
                  <i class="fa fa-exclamation-triangle"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text due-collection-title">@lang('lang_v1.pending_due_today')</span>
                  <span class="info-box-number due-collection-amount">
                    @format_currency($details['due_collections']['pending_due_today'])
                  </span>
                  <span class="progress-description due-collection-desc">
                    {{ $details['due_collections']['pending_transactions_count'] }} @lang('lang_v1.transactions')
                  </span>
                </div>
              </div>
            </div>
            @if($details['due_collections']['overdue_amount'] > 0)
            <div class="col-md-4">
              <div class="info-box bg-red due-collection-box">
                <span class="info-box-icon due-collection-icon">
                  <i class="fa fa-exclamation-circle"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text due-collection-title">@lang('lang_v1.overdue_amounts')</span>
                  <span class="info-box-number due-collection-amount">
                    @format_currency($details['due_collections']['overdue_amount'])
                  </span>
                  <span class="progress-description due-collection-desc">
                    {{ $details['due_collections']['overdue_transactions_count'] }} @lang('lang_v1.transactions')
                  </span>
                </div>
              </div>
            </div>
            @endif
          </div>
        </div>
      </div>
      @endif

      <hr>
      @if(!empty($register_details->denominations))
      @php
      $total = 0;
      @endphp
      <div class="row">
        <div class="col-md-8 col-sm-12">
          <h3>@lang( 'lang_v1.cash_denominations' )</h3>
          <table class="table table-slim">
            <thead>
              <tr>
                <th width="20%" class="text-right">@lang('lang_v1.denomination')</th>
                <th width="20%">&nbsp;</th>
                <th width="20%" class="text-center">@lang('lang_v1.count')</th>
                <th width="20%">&nbsp;</th>
                <th width="20%" class="text-left">@lang('sale.subtotal')</th>
              </tr>
            </thead>
            <tbody>
              @foreach($register_details->denominations as $key => $value)
              <tr>
                <td class="text-right">{{$key}}</td>
                <td class="text-center">X</td>
                <td class="text-center">{{$value ?? 0}}</td>
                <td class="text-center">=</td>
                <td class="text-left">
                  @format_currency($key * $value)
                </td>
              </tr>
              @php
              $total += ($key * $value);
              @endphp
              @endforeach
            </tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-center">@lang('sale.total')</th>
                <td>@format_currency($total)</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
      @endif

      <div class="row">
        <div class="col-xs-6">
          <b>@lang('report.user'):</b> {{ $register_details->user_name}}<br>
          <b>@lang('business.email'):</b> {{ $register_details->email}}<br>
          <b>@lang('business.business_location'):</b> {{ $register_details->location_name}}<br>
        </div>
        @if(!empty($register_details->closing_note))
        <div class="col-xs-6">
          <strong>@lang('cash_register.closing_note'):</strong><br>
          {{$register_details->closing_note}}
        </div>
        @endif
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="tw-dw-btn tw-dw-btn-primary tw-text-white no-print print-mini-button"
        aria-label="Print">
        <i class="fa fa-print"></i> @lang('messages.print_mini')
      </button>
      <button type="button" class="tw-dw-btn tw-dw-btn-primary tw-text-white no-print" aria-label="Print"
        onclick="$(this).closest('div.modal').printThis();">
        <i class="fa fa-print"></i> @lang( 'messages.print_detailed' )
      </button>

      <button type="button" class="tw-dw-btn tw-dw-btn-neutral tw-text-white no-print" data-dismiss="modal">@lang(
        'messages.cancel' )
      </button>
    </div>

  </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
```

---

## Step 4: Add Language Entries

Add these entries to your `resources/lang/en/lang_v1.php` file:

```php
return [
    // ... existing entries ...

    'due_collections_today' => 'Today's Due Collections',
    'collected_today' => 'Collected Today',
    'pending_due_today' => 'Pending Due Today',
    'overdue_amounts' => 'Overdue Amounts',
    'transactions' => 'Transactions',

    // ... rest of your language entries ...
];
```

--- 

By following these steps, you will successfully update the `CashRegisterUtil`, the controller, and the views to display comprehensive due collections data, and you will add the necessary language entries for smooth localization.
