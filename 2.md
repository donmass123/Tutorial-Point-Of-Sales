
# Stock Report Filter Enhancement Tutorial

This comprehensive tutorial guides you through enhancing the Stock Report functionality in Ultimate POS by adding advanced filtering capabilities, including multi-select filters.

## Overview
This enhancement transforms the standard Stock Report into a powerful filtering tool with multi-select capabilities.

---

## Stock Report Filter Enhancement

### What This Enhancement Adds
- Multi-select capability for all existing filters (Location, Category, Sub-category, Brand, Unit).
- Stock level filter with options: All, Greater than Zero, Less than One.
- "All" option handling for improved user experience.
- Improved filtering logic for better performance and accuracy.

### Benefits
✅ Multi-dimensional Filtering: Select multiple categories, brands, locations simultaneously.  
✅ Improved User Experience: Intuitive "All" options and clear filter states.  
✅ Enhanced Performance: Optimized database queries for complex filters.  
✅ Proper Currency Display: Consistent formatting with currency symbols.  

---

## Implementation Steps

### Step 1: Update `ReportController.php`

#### 1.1 Add the Enhanced `getStockValue` Method
Replace your existing `getStockValue` method with this enhanced version:

```php
public function getStockValue(Request $request)
{
    try {
        // Your logic...
    } catch (\Exception $e) {
        // Error handling
    }
}
```

#### 1.2 Add the `processStockValueFilters` Method
Add this new private method to handle filter processing:

```php
private function processStockValueFilters(Request $request)
{
    $filters = [];

    // Define filter mappings
    $filterMappings = [
        'location_id' => $request->input('location_id'),
        'category_id' => $request->input('category_id'),
        'sub_category_id' => $request->input('sub_category_id'),
        'brand_id' => $request->input('brand_id'),
        'unit_id' => $request->input('unit_id'),
        'stock_level' => $request->input('stock_level')
    ];

    foreach ($filterMappings as $key => $value) {
        if (!empty($value)) {
            // Your filter processing logic...
        }
    }

    return $filters;
}
```

#### 1.3 Update the `getStockReport` Method
Update your existing `getStockReport` method to include the enhanced filter processing:

```php
public function getStockReport(Request $request)
{
    // Your logic...
}
```

#### 1.4 Add the `processEnhancedStockReportFilters` Method
Add this method to handle enhanced stock report filtering:

```php
private function processEnhancedStockReportFilters(Request $request)
{
    // Get all possible filters
    $filters = $request->only([ /* your filters */ ]);
    
    // Multi-select filters that need special processing
    $multiSelectFilters = ['location_id', 'category_id', 'sub_category_id', 'brand_id', 'unit_id'];

    // Your logic...
    
    return $filters;
}
```

---

### Step 2: Update `TransactionUtil.php`

Update your `getOpeningClosingStock` method to support multi-select filters:

```php
public function getOpeningClosingStock($business_id, $date, $location_id, $is_opening = false, $by_sale_price = false, $filters = [], $permitted_locations = null)
{
    $query = PurchaseLine::join('transactions as purchase', 'purchase_lines.transaction_id', '=', 'purchase.id')
        // Your query logic...
    
    if (!empty($filters['category_id'])) {
        if (is_array($filters['category_id'])) {
            $query->whereIn('p.category_id', $filters['category_id']);
        } else {
            $query->where('p.category_id', $filters['category_id']);
        }
    }
    
    // Handle multi-select filters for other fields...
}
```

---

### Step 3: Update the Blade View

Replace your `resources/views/report/stock_report.blade.php` file with this enhanced version:

```blade
@extends('layouts.app')
@section('title', __('report.stock_report'))

@section('content')
    <section class="content-header">
        <h1 class="tw-text-xl md:tw-text-3xl tw-font-bold tw-text-black">{{ __('report.stock_report')}}</h1>
    </section>

    <section class="content">
        <div class="row">
            <div class="col-md-12">
                @component('components.filters', ['title' => __('report.filters')])
                    {!! Form::open(['url' => action([\App\Http\Controllers\ReportController::class, 'getStockReport']), 'method' => 'get', 'id' => 'stock_report_filter_form' ]) !!}
                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('location_id', __('purchase.business_location') . ':') !!}
                            {!! Form::select('location_id[]', $business_locations, null, [
                            'class' => 'form-control select2',
                            'style' => 'width:100%',
                            'multiple',
                            'id' => 'location_id'
                            ]); !!}
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('category_id', __('category.category') . ':') !!}
                            {!! Form::select('category_id[]', $categories, null, [
                            'placeholder' => __('messages.all'),
                            'class' => 'form-control select2',
                            'style' => 'width:100%',
                            'id' => 'category_id',
                            'multiple'
                            ]); !!}
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('sub_category_id', __('product.sub_category') . ':') !!}
                            {!! Form::select('sub_category_id[]', array(), null, [
                            'placeholder' => __('messages.all'),
                            'class' => 'form-control select2',
                            'style' => 'width:100%',
                            'id' => 'sub_category_id',
                            'multiple'
                            ]); !!}
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('brand', __('product.brand') . ':') !!}
                            {!! Form::select('brand[]', $brands, null, [
                            'placeholder' => __('messages.all'),
                            'class' => 'form-control select2',
                            'style' => 'width:100%',
                            'id' => 'brand',
                            'multiple'
                            ]); !!}
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('unit',__('product.unit') . ':') !!}
                            {!! Form::select('unit[]', $units, null, [
                            'placeholder' => __('messages.all'),
                            'class' => 'form-control select2',
                            'style' => 'width:100%',
                            'id' => 'unit',
                            'multiple'
                            ]); !!}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            {!! Form::label('stock_level', __('report.stock_level') . ':') !!}
                            {!! Form::select('stock_level', [
                            '' => __('messages.all'),
                            'gt_zero' => __('report.greater_than_zero'),
                            'lt_one' => __('report.less_than_one')
                            ], null, ['class' => 'form-control select2', 'style' => 'width:100%', 'id' => 'stock_level']); !!}
                        </div>
                    </div>
                    @if($show_manufacturing_data)
                    <div class="col-md-3">
                        <div class="form-group">
                            <br>
                            <div class="checkbox">
                                <label>
                                    {!! Form::checkbox('only_mfg', 1, false,
                                    [ 'class' => 'input-icheck', 'id' => 'only_mfg_products']); !!} {{
                                    __('manufacturing::lang.only_mfg_products') }}
                                </label>
                            </div>
                        </div>
                    </div>
                    @endif
                    {!! Form::close() !!}
                @endcomponent
            </div>
        </div>
    </section>
@endsection

@section('javascript')
<script src="{{ asset('js/report.js?v=' . $asset_v) }}"></script>
<script type="text/javascript">
    // Your javascript logic...
</script>
@endsection
```

---

### Step 4: Update `public/js/report.js`

Update your `public/js/report.js` file to include the stock level filter in the DataTable configuration and change handlers.

#### 4.1 Add Stock Level to DataTable Configuration

```javascript
stock_report_table = $('#stock_report_table').DataTable({
    // Your DataTable configuration...
    ajax: {
        url: '/reports/stock-report',
        data: function (d) {
            d.stock_level = $('#stock_level').val();
        },
    },
});
```

#### 4.2 Update Filter Change Handlers

```javascript
$('#stock_report_filter_form #location_id, #stock_report_filter_form #category_id, #stock_report_filter_form #sub_category_id, #stock_report_filter_form #brand, #stock_report_filter_form #unit, #stock_report_filter_form #stock_level').change(function () {
    stock_report_table.ajax.reload();
    stock_expiry_report_table.ajax.reload();
    get_stock_value();
});
```

### Step 5: Add Subcategory Methods to ProductController

If you don't already have these methods, add them to your `ProductController` to handle dynamic subcategory loading:

#### 5.1 Add `getSubCategories` Method

```php
public function getSubCategories(Request $request)
{
    if (request()->ajax()) {
        // Your logic...
    }
}
```

#### 5.2 Add `getSubCategoriesMulti` Method

```php
public function getSubCategoriesMulti(Request $request)
{
    if (request()->ajax()) {
        // Your logic...
    }
}
```

#### 5.3 Add Routes for Subcategory Methods

```php
Route::get('/products/get-sub-categories', [\App\Http\Controllers\ProductController::class, 'getSubCategories']);
Route::post('/products/get_sub_categories_multi', [\App\Http\Controllers\ProductController::class, 'getSubCategoriesMulti']);
```

---

## How It Works

### Multi-Select Filter Processing
1. **Frontend Collection**: JavaScript collects values from multi-select dropdowns.
2. **Array Filtering**: Empty values and "All" selections are filtered out.
3. **Backend Processing**: PHP processes arrays and single values consistently.
4. **Database Querying**: Uses `whereIn()` for arrays and `where()` for single values.

### Stock Value Calculation
1. **Filter Processing**: Enhanced filters are processed and cleaned.
2. **Purchase Price Calculation**: Uses `getOpeningClosingStock()` with `by_sale_price = false`.
3. **Sale Price Calculation**: Uses `getOpeningClosingStock()` with `by_sale_price = true`.
4. **Currency Formatting**: Backend formats values using `num_f(value, true)` for currency display.

### "All" Option Logic
1. **Empty dropdown selection = "All"** (no filter applied).
2. **Selecting "All" with other options removes the other options**.
3. **Backend treats empty arrays as no filter applied**.

## Key Features
- **Multi-Select Capabilities**: Multiple Locations, Categories, Brands, Units.
- **Enhanced Stock Value Display**: Purchase Price, Sale Price, Potential Profit, and Profit Margin.
- **Robust Error Handling**: AJAX Error Management and Filter Validation.
- **Currency Display**: Consistent currency formatting.

## Benefits
- **Improved User Experience**: Intuitive multi-select interface with clear options.
- **Better Data Analysis**: Multiple dimension filtering for comprehensive insights.
- **Consistent Formatting**: Proper currency display with business-specific symbols.
- **Enhanced Performance**: Optimized queries for multi-select filters.
- **Maintainable Code**: Clean, well-structured code following Laravel best practices.

This enhancement significantly improves the stock reporting capabilities while maintaining backward compatibility and following established patterns in your Ultimate POS application.
