# Huge Db size in Ultimate POS​

**Goal**: Reduce database size by safely removing auto-generated duplicate entries in transaction_sell_lines_purchase_lines — one of the most bloated tables in UltimatePOS.

### ✅ What This Fix Did for Me​

- **Database Before**: ~4 GB
- **Database After Cleanup**: ~80 MB 😲
- **✅ No issues or data loss in sales or inventory after cleanup**

Run this SQL in `phpMyAdmin` (or any SQL tool):


```sql
SELECT COUNT(*) AS remaining_duplicates
FROM transaction_sell_lines_purchase_lines t
JOIN (
SELECT purchase_line_id, MIN(id) AS min_id
FROM transaction_sell_lines_purchase_lines
WHERE sell_line_id IS NULL
GROUP BY purchase_line_id
HAVING COUNT(*) > 1
) grouped ON t.purchase_line_id = grouped.purchase_line_id
WHERE t.sell_line_id IS NULL AND t.id != grouped.min_id;
```

### 🔍 This shows how many duplicate rows exist where sell_line_id is NULL (a common duplication issue).

## 🧾 STEP 2: Preview 100 Duplicate Records​

**Preview 100 duplicates before deletion**:

```sql
SELECT dup.*
FROM transaction_sell_lines_purchase_lines AS dup
JOIN (
SELECT sell_line_id, purchase_line_id, MIN(id) AS min_id
FROM transaction_sell_lines_purchase_lines
GROUP BY sell_line_id, purchase_line_id
HAVING COUNT(*) > 1
) AS grouped
ON dup.sell_line_id = grouped.sell_line_id
AND dup.purchase_line_id = grouped.purchase_line_id
AND dup.id != grouped.min_id
LIMIT 100;
```

### 🧠 TIP: This won't delete anything — just lists the duplicates for your inspection.


## STEP 3: Safely Delete Duplicates in Batches​

Start small! Try deleting 100 at a time:

```sql
DELETE FROM transaction_sell_lines_purchase_lines
WHERE id IN (
SELECT id FROM (
SELECT t.id
FROM transaction_sell_lines_purchase_lines t
JOIN (
SELECT sell_line_id, purchase_line_id, MIN(id) AS min_id
FROM transaction_sell_lines_purchase_lines
GROUP BY sell_line_id, purchase_line_id
HAVING COUNT(*) > 1
) grouped ON (t.sell_line_id <=> grouped.sell_line_id AND t.purchase_line_id = grouped.purchase_line_id)
WHERE t.id != grouped.min_id
LIMIT 100
) AS subquery
);
```

**💡 You can change LIMIT 100 to 500, 1000, or more based on**:

Server power (shared hosting, VPS, cloud)
Current load (run only during idle/off-peak time)


**Now perform optimize quiery** :

OPTIMIZE TABLE `transaction_sell_lines_purchase_lines`;


📌 Important Notes​

## ✅ What to DO:​

- ✔️ Backup your database first!
- ✔️ Run during low or zero usage (midnight/off-hours)
- ✔️ Start with LIMIT 100 before increasing
- ✔️ Monitor your POS system after each delete run
- ✔️ Document total count before/after cleanup

## ❌ What NOT to DO:​

- ❌ Don't run during business hours
- ❌ Don’t delete without reviewing a sample first
- ❌ Don’t blindly delete all in one go on shared servers
- ❌ Don’t skip the backup — ever!


**You can connect me I will help :**
I suffered a lot and reach to solution even I can perform on live server No data losses will be happen

---
[← Previous: Due Collections Feature](4.md)  |  [Next →: Delete Transaction, Product, Inventory](6.md)